name: frankenphp

project_files:
  - config.frankenphp.yaml
  - docker-compose.frankenphp.yaml
  - web-build/prepend.Dockerfile.frankenphp
  - web-build/Dockerfile.frankenphp

pre_install_actions:
  - |
    #ddev-description:Removing old files
    for file in "${DDEV_APPROOT}/.ddev/commands/host/xdebug" "${DDEV_APPROOT}/.ddev/php/docker-php-ext-xdebug.ini" "${DDEV_APPROOT}/.ddev/frankenphp/Caddyfile" "${DDEV_APPROOT}/.ddev/commands/frankenphp/php" "${DDEV_APPROOT}/.ddev/frankenphp/Dockerfile"; do
      if [ -f "${file}" ]; then
        if grep -q '#ddev-generated' "${file}"; then
          rm -f "${file}"
        else
          echo "${file} needs to be removed but has been modified by the user. Please check it and remove it"
          exit 2
        fi
      fi
    done

post_install_actions:
  - |
    #ddev-description:Detecting Debian codename for FrankenPHP image build
    debian_codename=$(docker run --rm "$(ddev version -j 2>/dev/null | docker run --rm -i ddev/ddev-utilities jq -r .raw.web 2>/dev/null)" bash -c 'source /etc/os-release && echo $VERSION_CODENAME' 2>/dev/null)
    if [ "${debian_codename}" != "" ]; then
      ddev dotenv set .ddev/.env.web --frankenphp-debian-codename="${debian_codename}"
    fi

ddev_version_constraint: '>= v1.24.10'
